#!/usr/bin/env bash

#
# Description:
# Generates Flash and RAM files from an ELF file for a memory usage analysis.
# The Script uses the NM tool of the compiler toolchain to generate the flash
# memory usage file. For the RAM memory file, it searchs, merges and sorts the
# content of all .su files that has been generated by the compiler on a
# previous built (so "-fstack-usage" flag is required to be provided to the
# compiler for having the .su files after a compilation is done, also passing
# "-flto" flag could prevent the creation of that files).
#

###############################################################################

# Project built files directory
DIR=$1
FILE_ELF=$2
FILE_OUT_FLASH="memory_flash.txt"
FILE_OUT_RAM="memory_ram.txt"

# Check if argument for ELF file has been provided
if [ $# -lt 2 ]; then
    echo "Build directory path required as argument."
    echo "Examples:"
    echo "  memory_check.sh ./build ./build/binary.elf"
    echo ""
    exit 1
fi

# Generate Program Memory usage file
echo "" > ${DIR}/${FILE_OUT_FLASH}
echo "ADDRESS    SIZE    FUNCTION    FILE:LINE" >> ${DIR}/${FILE_OUT_FLASH}
echo "-----------------------------------------" >> ${DIR}/${FILE_OUT_FLASH}
nm --line-numbers --print-size --size-sort --radix=d ${FILE_ELF} >> ${DIR}/${FILE_OUT_FLASH}

# Generate a full Static RAM Memory usage file
FILES=$(find ${DIR} -type f \( -iname "*.su" \))
echo "" > ${DIR}/tmp.txt
for file in $FILES
do
    cat $file >> ${DIR}/tmp.txt
    echo  "" >> ${DIR}/tmp.txt
done

# Sort by size and check for Static and Dynamic memory usage
echo "" > ${DIR}/${FILE_OUT_RAM}
echo "Static memory usage:" >> ${DIR}/${FILE_OUT_RAM}
echo "" >> ${DIR}/${FILE_OUT_RAM}
grep -v -e '^$' ${DIR}/tmp.txt | sort -u | sort -t$'\t' -k2 -g > ${DIR}/tmp_sort.txt
cat ${DIR}/tmp_sort.txt | grep -v "\tdynamic" >> ${DIR}/${FILE_OUT_RAM}
echo "" >> ${DIR}/${FILE_OUT_RAM}
echo "-----------------------------------------" >> ${DIR}/${FILE_OUT_RAM}
echo "" >> ${DIR}/${FILE_OUT_RAM}
echo "Dynamic memory usage detected in:" >> ${DIR}/${FILE_OUT_RAM}
echo "" >> ${DIR}/${FILE_OUT_RAM}
cat ${DIR}/tmp_sort.txt | grep -P "\tdynamic" >> ${DIR}/${FILE_OUT_RAM}
echo "" >> ${DIR}/${FILE_OUT_RAM}

# Remove temporary files
#rm -f ${DIR}/tmp.txt
#rm -f ${DIR}/tmp_sort.txt

exit 0
